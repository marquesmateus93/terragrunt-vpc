resources:
  repositories:
    - repository: azure-devops-templates
      type: github
      name: Dev-Marques-Ops-Templates/azure-devops-templates
      endpoint: Marques

variables:
  - group: AWS
  - group: GitHub
  - name: User_Email
    ${{ if eq('${{Build.RequestedForEmail}}', '') }}:
      value: "git@pipeline.com"
    ${{ else }}:
      value: $(Build.RequestedForEmail)

steps:
  - template: awscli/install.yaml@azure-devops-templates
  - template: terraform/install.yaml@azure-devops-templates
  - template: terragrunt/install.yaml@azure-devops-templates
  - template: git/setup.yaml@azure-devops-templates
    parameters:
      KnownHostsEntry: $(SSHKeySecureFile)
      SSHKeySecureFile: 'Azure Devops'
      User_Email: ${{variables.USER_EMAIL}}

  - template: terragrunt/plan.yaml@azure-devops-templates
    parameters:
      TerragruntWorkDir: dev/us-east-1/tags
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)